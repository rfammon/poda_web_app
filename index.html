<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Mental: Procedimento de Corte e Poda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Fundo muito claro */
        }
        .mind-map-node {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
        }
        .mind-map-node:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* Cor de contraste para o tema (Verde da Natureza) */
        .theme-color-bg { background-color: #38a169; } /* Verde Escuro */
        .theme-color-text { color: #38a169; }
        .phase-bg-gestao { background-color: #f6ad55; } /* Laranja */
        .phase-bg-planejamento { background-color: #4299e1; } /* Azul */
        .phase-bg-mobilizacao { background-color: #9f7aea; } /* Roxo */
        .phase-bg-execucao { background-color: #48bb78; } /* Verde claro */
        .phase-bg-desmobilizacao { background-color: #ed8936; } /* Laranja escuro */
        .phase-bg-seguranca { background-color: #f56565; } /* Vermelho (Safety) */
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

<div id="app" class="max-w-7xl mx-auto">

    <!-- Cabe√ßalho -->
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-gray-800">Mapa Mental: Procedimento de Corte e Poda</h1>
        <p class="text-gray-600 mt-2">Guia r√°pido interativo para consulta das fases do manual.</p>
    </header>

    <div class="flex flex-col lg:flex-row gap-8">
        
        <!-- Coluna do Mapa Mental (50% na tela grande) -->
        <div id="mind-map-container" class="lg:w-1/2 w-full flex flex-col gap-6">
            
            <!-- N√≥ Central -->
            <div class="flex justify-center">
                <div class="theme-color-bg text-white p-6 rounded-full text-xl font-bold text-center shadow-xl w-64 h-64 flex items-center justify-center">
                    MANUAL CORTE E PODA DE √ÅRVORES
                </div>
            </div>

            <!-- Fases do Procedimento (Renderizadas por JS) -->
            <div id="phases-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                <!-- Conte√∫do ser√° injetado pelo JavaScript -->
            </div>
        </div>

        <!-- Coluna dos Pain√©is de Informa√ß√£o (50% na tela grande) -->
        <div class="lg:w-1/2 w-full">
            
            <!-- Container que ser√° STICKY para TODOS os 3 pain√©is -->
            <div class="space-y-8 sticky top-8">
                
                <!-- Pergunte ao Manual Panel (AGORA STICKY) -->
                <div id="gemini-panel" class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-gray-700">
                    <h2 class="text-2xl font-bold mb-4 text-gray-700">Pergunte ao Manual</h2>
                    <textarea id="gemini-input" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Ex: Qual o procedimento para corte de √°rvores com risco iminente?"></textarea>
                    <button id="gemini-button" onclick="askGemini()" class="mt-2 w-full theme-color-bg text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200">
                        Pergunte ao Manual
                    </button>
                    <div id="gemini-results" class="mt-4 p-3 bg-gray-50 border rounded-lg text-sm min-h-[50px]">
                        <p class="text-gray-500 italic">As respostas aparecer√£o aqui.</p>
                    </div>
                </div>

                <!-- Painel de Conte√∫do/Explica√ß√£o Completa (AGORA STICKY) -->
                <div id="content-panel" class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-blue-500">
                    <h2 class="text-2xl font-bold mb-4 text-blue-600">Conte√∫do Detalhado</h2>
                    <div id="content-explanation">
                        <p class="text-gray-500 italic">
                            Clique em um t√≥pico do mapa mental para ler a explica√ß√£o completa da se√ß√£o do manual.
                        </p>
                    </div>
                </div>

                <!-- Painel do Gloss√°rio Interativo (AGORA STICKY) -->
                <div id="glossary-panel" class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-gray-400">
                    <h2 class="text-2xl font-bold mb-4 theme-color-text">Gloss√°rio R√°pido</h2>
                    
                    <div id="glossary-definition">
                        <p class="text-gray-500 italic">
                            Aqui aparecer√° o termo chave (defini√ß√£o resumida).
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Dados EXTRA√çDOS e expandidos do Manual fornecido pelo usu√°rio
    const mindMapData = [
        { 
            phase: 'Gest√£o', 
            bgColor: 'phase-bg-gestao', 
            topics: [
                { 
                    name: 'Autoriza√ß√µes e Licenciamento (ASV/APP)', 
                    link: '#gestao_licenca', 
                    term: 'ASV', 
                    definition: 'Autoriza√ß√£o de Supress√£o de Vegeta√ß√£o. Documento emitido pelo √≥rg√£o ambiental competente que autoriza o corte ou supress√£o de vegeta√ß√£o nativa ou √°rvores isoladas.',
                    fullContent: 'Toda interven√ß√£o deve ser realizada com anu√™ncia do setor de meio ambiente. <b>ASV:</b> Documento emitido pelo √≥rg√£o ambiental que autoriza o corte. <b>APP (√Årea de Preserva√ß√£o Permanente):</b> Espa√ßo protegido por lei. Interven√ß√µes permitidas apenas em casos de utilidade p√∫blica, interesse social ou baixo impacto ambiental. <b>Dispensa:</b> Indiv√≠duos com DAP inferior a 0,05 m fora de APP est√£o dispensados. Casos de risco iminente, comprovado por defesa civil, podem ter supress√£o *a posteriori*.'
                },
                { 
                    name: 'Responsabilidades (RACI) e Compensa√ß√£o', 
                    link: '#gestao_raci', 
                    term: 'TCRA', 
                    definition: 'Termo de Compromisso de Recupera√ß√£o Ambiental. Instrumento legal que formaliza a obriga√ß√£o de compensa√ß√£o ambiental por meio de a√ß√µes de recupera√ß√£o ou preserva√ß√£o.',
                    fullContent: 'A <b>Compensa√ß√£o Ambiental</b> √© obrigat√≥ria para mitigar impactos de supress√£o de vegeta√ß√£o nativa ou interven√ß√£o em APP. O c√°lculo pode variar de <b>1,25x at√© 6x</b> a √°rea suprimida, dependendo do tipo de vegeta√ß√£o e da prioridade ambiental da √°rea. As formas de compensa√ß√£o incluem restaura√ß√£o ecol√≥gica, preserva√ß√£o remanescente ou compensa√ß√£o em propriedade de terceiros. A Matriz <b>RACI</b> (Respons√°vel, Aprovador, Consultado e Informado) define os pap√©is do processo.'
                }
            ] 
        },
        { 
            phase: 'Planejamento', 
            bgColor: 'phase-bg-planejamento', 
            topics: [
                { 
                    name: 'Inspe√ß√£o Visual Expedita e Risco (48h/15 dias)', 
                    link: '#planejamento_risco', 
                    term: 'ALTO RISCO', 
                    definition: 'Defeitos cr√≠ticos pr√≥ximos a alvos estrat√©gicos. Exige interven√ß√£o em at√© 48h. Baseado em sistema de pontua√ß√£o do ANEXO II.',
                    fullContent: 'An√°lise minuciosa de <b>5 a 10 minutos</b> por √°rvore, com foco em: fendas horizontais, carp√≥foros (cogumelos), galhos mortos com di√¢metro superior a 5 cm, uni√µes em ‚ÄúV‚Äù com casca inclusa, e assimetria acentuada da copa (>30%). <b>Classifica√ß√£o de Risco:</b> üî¥ ALTO (at√© 48h); üü† M√âDIO (at√© 15 dias); üü¢ BAIXO (Monitoramento anual).'
                },
                { 
                    name: 'Avalia√ß√£o Radicular e RCR', 
                    link: '#planejamento_rcr', 
                    term: 'RCR', 
                    definition: 'Raio Cr√≠tico Radicular. √Årea de influ√™ncia e sustenta√ß√£o mec√¢nica das ra√≠zes, onde o Raio √© calculado como 1,5 √ó DAP.',
                    fullContent: 'O <b>Raio Cr√≠tico Radicular (RCR)</b> √© delimitado por: Raio = 1,5 √ó DAP. Dentro desta √°rea, verificar interfer√™ncias com infraestrutura (cal√ßadas rachadas), perda de mais de 40% de ra√≠zes de sustenta√ß√£o, compacta√ß√£o/asfixia e apodrecimento em ra√≠zes prim√°rias (>3 cm). <b>Poda de Ra√≠zes deve ser evitada e requer profissional habilitado.</b>' 
                },
                { 
                    name: 'Plano de Trabalho Detalhado', 
                    link: '#planejamento_plano', 
                    term: 'Crit√©rios de Aceita√ß√£o', 
                    definition: 'Condi√ß√µes definidas previamente (Ex: defeitos corrigidos, res√≠duos removidos com seguran√ßa) para que a atividade seja dada como conclu√≠da.',
                    fullContent: 'O Plano deve consolidar todas as informa√ß√µes para execu√ß√£o segura. Deve contemplar: <b>Objetivo e Escopo</b>, <b>Local e Condi√ß√µes Operacionais</b>, <b>Atividades Espec√≠ficas</b>, <b>Crit√©rios de Aceita√ß√£o</b>, <b>Recursos e Equipamentos</b> e <b>Cronograma</b>. A supervis√£o ativa √© obrigat√≥ria em todas as etapas, com meios de comunica√ß√£o dispon√≠veis.'
                }
            ] 
        },
        { 
            phase: 'Mobiliza√ß√£o', 
            bgColor: 'phase-bg-mobilizacao', 
            topics: [
                { 
                    name: 'Delimita√ß√£o de Isolamento e Per√≠metro', 
                    link: '#mobilizacao_isolamento', 
                    term: 'Per√≠metro de Exclus√£o', 
                    definition: 'Raio de perigo a ser isolado, calculado como Comprimento do galho + 50% ou Altura da √°rvore + 50% (para √°rvore inteira).', 
                    fullContent: 'O isolamento √© obrigat√≥rio e deve usar Pedestais met√°licos/pl√°sticos (m√°x. 2,5m) e correntes pl√°sticas (Preto/Amarelo). <b>√â proibido o uso de fita zebrada (salvo emerg√™ncias).</b> Deve-se criar rotas alternativas para pedestres (m√≠nimo 2m do per√≠metro) e garantir pelo menos dois acessos em √°reas extensas.'
                },
                { 
                    name: 'Pr√©-Servi√ßo e Desligamento de Energia', 
                    link: '#mobilizacao_energia', 
                    term: 'Restri√ß√µes Operacionais', 
                    definition: 'Proibi√ß√£o de podas ou cortes em √°rvores que estejam em contato com redes ativas. Em caso de impossibilidade de desligamento, a atividade deve ser suspensa.',
                    fullContent: '<b>Inspe√ß√£o Pr√©-Servi√ßo:</b> Verificar umidade, inclina√ß√£o do terreno, obst√°culos e animais pe√ßonhentos. <b>Desligamento de Linhas:</b> Essencial em interfer√™ncias com redes el√©tricas. Deve ser solicitado formalmente e confirmado. Proibido o trabalho com redes ativas.'
                },
                 { 
                    name: 'Libera√ß√£o de Permiss√£o de Trabalho (PT)', 
                    link: '#mobilizacao_pt', 
                    term: 'PT', 
                    definition: 'Permiss√£o de Trabalho. Documento obrigat√≥rio para execu√ß√£o segura, que deve contemplar riscos, medidas preventivas e a√ß√µes de emerg√™ncia.',
                    fullContent: 'A <b>PT √© obrigat√≥ria</b> e deve ser elaborada conforme o escopo, riscos e medidas preventivas. Deve ser validada com a equipe de seguran√ßa e permanecer dispon√≠vel no local. Qualquer altera√ß√£o no escopo ou nas condi√ß√µes do trabalho exige <b>revalida√ß√£o da PT</b>.'
                }
            ] 
        },
        { 
            phase: 'Execu√ß√£o', 
            bgColor: 'phase-bg-execucao', 
            topics: [
                { 
                    name: 'T√©cnicas de Poda (Tr√™s Cortes)', 
                    link: '#execucao_corte', 
                    term: 'Colar do Galho', 
                    definition: 'Zona especializada na base do galho, respons√°vel pela compartimentaliza√ß√£o de ferimentos. Deve ser preservado no corte de acabamento.',
                    fullContent: 'Aplicar a <b>Poda em Tr√™s Cortes</b> para preservar a crista da casca e o colar do galho: 1) Corte inferior (al√≠vio, fora do colar); 2) Corte superior (destaque); 3) Corte de acabamento (rente √† crista). <b>Pr√°ticas a Evitar:</b> Poda dr√°stica (topping), Corte cego (tipping), Cortes rentes e com toco.'
                },
                { 
                    name: 'Tipos de Poda (Desbaste, Eleva√ß√£o, Redu√ß√£o)', 
                    link: '#execucao_tipos', 
                    term: 'Desbaste da Copa', 
                    definition: 'Remo√ß√£o seletiva de galhos internos para aumentar a penetra√ß√£o de luz e a circula√ß√£o de ar, respeitando o limite de at√© 25% da copa viva por interven√ß√£o.',
                    fullContent: '<b>Desbaste:</b> Remove galhos internos (m√°x. 25% da copa viva). <b>Eleva√ß√£o:</b> Remove galhos inferiores, mantendo pelo menos 2/3 da altura total com copa viva. <b>Redu√ß√£o:</b> Diminui o volume por corte em garfo, preservando ramos laterais com di√¢metro ‚â• 1/3 do ramo removido. <b>Evitar Poda Dr√°stica.</b>'
                },
                { 
                    name: 'Supress√£o, Abate Direcional e Rota de Fuga', 
                    link: '#execucao_supressao', 
                    term: 'Corte Direcional', 
                    definition: 'T√©cnica de abate que consiste em fazer um entalhe de 45¬∫ a 70¬∫ e um corte de abate oposto, deixando uma "dobradi√ßa" para direcionar a queda.',
                    fullContent: 'A supress√£o √© s√≥ em casos de risco ou determina√ß√£o legal. O <b>Corte Direcional</b> define o sentido da queda (entalhe + corte de abate). <b>Rota de Fuga:</b> Planejar duas rotas livres de obst√°culos, formando um √¢ngulo de aproximadamente <b>45¬∞</b> em rela√ß√£o √† dire√ß√£o de queda.'
                }
            ] 
        },
        { 
            phase: 'Desmobiliza√ß√£o', 
            bgColor: 'phase-bg-desmobilizacao', 
            topics: [
                { 
                    name: 'Gest√£o de Res√≠duos e PNRS', 
                    link: '#desmob_residuos', 
                    term: 'PNRS', 
                    definition: 'Pol√≠tica Nacional de Res√≠duos S√≥lidos. Lei n¬∫ 12.305/2010 que estabelece diretrizes para o manejo adequado dos res√≠duos s√≥lidos.',
                    fullContent: 'Priorizar: <b>N√£o Gera√ß√£o/Redu√ß√£o</b> e <b>Reutiliza√ß√£o/Reciclagem</b> (biomassa, compostagem, mulch). <b>Destina√ß√£o:</b> Encaminhar somente para instala√ß√µes licenciadas. <b>Operacional:</b> Segregar por tipo (lenhoso/foliar) e armazenar temporariamente em √°rea sinalizada com controle de acesso.'
                },
                { 
                    name: 'Transporte, MTR e Movimenta√ß√£o Segura', 
                    link: '#desmob_transporte', 
                    term: 'MTR', 
                    definition: 'Manifesto de Transporte de Res√≠duos. Documento que garante a rastreabilidade dos res√≠duos desde a origem at√© a destina√ß√£o final.',
                    fullContent: '<b>Movimenta√ß√£o Manual:</b> Somente para pe√ßas com peso compat√≠vel (NR 17). Usar t√©cnicas de levantamento corretas (coluna ereta, flexionar joelhos). <b>Movimenta√ß√£o Mec√¢nica:</b> Uso de equipamentos adequados (cintas, guinchos) e √°rea isolada. <b>Transporte:</b> Uso de ve√≠culos adequados, com enceramento e emiss√£o de MTR quando exigido.'
                },
                { 
                    name: 'Limpeza Final e Libera√ß√£o da √Årea', 
                    link: '#desmob_limpeza', 
                    term: 'Confer√™ncia', 
                    definition: 'Etapa que assegura a retirada completa de res√≠duos, remo√ß√£o de sinaliza√ß√£o e condi√ß√µes seguras da √°rea, antes da libera√ß√£o formal.',
                    fullContent: 'Remover todos os res√≠duos arb√≥reos conforme plano. Retirada de isolamento e sinaliza√ß√£o <b>somente ap√≥s a conclus√£o das atividades e libera√ß√£o formal</b>. Desenergizar e inspecionar equipamentos antes da retirada. A <b>Libera√ß√£o da √Årea</b> deve ser formalizada pelo respons√°vel t√©cnico.' 
                }
            ] 
        },
        { 
            phase: 'Seguran√ßa', 
            bgColor: 'phase-bg-seguranca', 
            topics: [
                { 
                    name: 'An√°lise de Risco (Rebote, Perigos, AST)', 
                    link: '#seguranca_risco', 
                    term: 'Efeito Rebote', 
                    definition: 'Ocorre quando a corrente, na ponta superior da l√¢mina guia (sabre), √© pin√ßada ou toca um objeto duro, projetando a motosserra em dire√ß√£o ao operador.',
                    fullContent: '<b>Perigos Recorrentes:</b> Queda de altura, Choque el√©trico, Corte/perfura√ß√£o, Picadas, Ru√≠do, Fadiga t√©rmica. <b>Preven√ß√£o de Rebote:</b> Nunca usar a ponta superior da l√¢mina. Segurar com firmeza, trabalhar em rota√ß√£o m√°xima. <b>AST:</b> An√°lise de Risco de Tarefa deve ser realizada antes de iniciar a atividade. Supervis√£o de seguran√ßa obrigat√≥ria.'
                },
                { 
                    name: 'Equipamentos de Prote√ß√£o Individual (EPIs)', 
                    link: '#seguranca_epis', 
                    term: 'Perneira', 
                    definition: 'EPI complementar listado para prote√ß√£o contra animais pe√ßonhentos e para uso com motosserra (cal√ßa motoserrista).',
                    fullContent: '<b>EPIs B√°sicos:</b> Capacete com jugular, Cal√ßado com biqueira, Viseira/protetor facial, Perneira. <b>Para Motosserra:</b> Luva, Blus√£o, Cal√ßa motoserrista, Protetor auricular (concha). <b>Para Altura:</b> Cinto paraquedista, Talabarte duplo com absorvedor, Trava-queda.'
                },
                { 
                    name: 'Trabalho em Altura (NR-35) e ZLQ', 
                    link: '#seguranca_altura', 
                    term: 'ZLQ', 
                    definition: 'Zona Livre de Queda. Dist√¢ncia de seguran√ßa m√≠nima (1 m do piso de refer√™ncia) a ser respeitada para evitar contato do trabalhador com o piso em caso de queda.',
                    fullContent: 'Observar requisitos da <b>NR-35</b>. Servi√ßos devem ser paralisados se a velocidade do vento for superior a <b>40 km/h</b>. A utiliza√ß√£o de equipamentos de prote√ß√£o contra queda deve levar em conta o comprimento dos acess√≥rios e prever a <b>ZLQ</b> de 1m. <b>Proibida a escalada livre</b> e a ancoragem do trabalhador nos galhos a serem cortados.'
                }
            ] 
        },
    ];

    const phasesGrid = document.getElementById('phases-grid');
    const glossaryDefinition = document.getElementById('glossary-definition');
    const contentExplanation = document.getElementById('content-explanation');


    // ---------------------------------------------------------------------
    // FUN√á√ïES DO MAPA MENTAL
    // ---------------------------------------------------------------------

    // Fun√ß√£o para renderizar o Mapa Mental
    function renderMindMap() {
        mindMapData.forEach(phaseData => {
            // Cria o card da Fase
            const phaseCard = document.createElement('div');
            phaseCard.className = `p-4 rounded-xl shadow-lg border-t-8 ${phaseData.bgColor}`;

            // T√≠tulo da Fase
            const phaseTitle = document.createElement('h3');
            phaseTitle.className = 'text-xl font-bold text-white mb-3 uppercase';
            phaseTitle.textContent = phaseData.phase;
            phaseCard.appendChild(phaseTitle);

            // Container dos T√≥picos
            const topicsList = document.createElement('div');
            topicsList.className = 'flex flex-col gap-3';

            phaseData.topics.forEach(topic => {
                // Cria o n√≥ do T√≥pico (interativo)
                const topicNode = document.createElement('a');
                topicNode.href = topic.link;
                topicNode.className = 'mind-map-node bg-white text-gray-800 p-3 block transition duration-200 hover:bg-gray-50 flex justify-between items-center';
                topicNode.innerHTML = `
                    <span class="font-medium">${topic.name}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                `;
                
                // Adiciona o evento de clique para o Gloss√°rio e Conte√∫do
                topicNode.addEventListener('click', (e) => {
                    e.preventDefault(); // Impede a navega√ß√£o do link placeholder
                    updatePanels(topic.name, topic.term, topic.definition, topic.fullContent, phaseData.phase);
                    
                    // Remove a classe de sele√ß√£o de todos os n√≥s
                    document.querySelectorAll('.mind-map-node').forEach(node => {
                        node.classList.remove('ring-4', 'ring-offset-2', 'ring-green-400', 'bg-green-50');
                    });
                    // Adiciona a classe de sele√ß√£o ao n√≥ clicado
                    topicNode.classList.add('ring-4', 'ring-offset-2', 'ring-green-400', 'bg-green-50');
                });

                topicsList.appendChild(topicNode);
            });

            phaseCard.appendChild(topicsList);
            phasesGrid.appendChild(phaseCard);
        });
    }

    // Fun√ß√£o para atualizar os pain√©is de Conte√∫do e Gloss√°rio
    function updatePanels(topicName, term, definition, fullContent, phase) {
        // --- Atualiza o Painel de Conte√∫do Detalhado ---
        contentExplanation.innerHTML = `
            <div class="space-y-4">
                <p class="text-sm font-semibold text-gray-500 uppercase">Fase ${phase} / T√≥pico: ${topicName}</p>
                <p class="text-base text-gray-700 leading-relaxed">${fullContent}</p>
                <hr class="mt-4 border-gray-200">
                <p class="text-xs text-gray-400">Conte√∫do extra√≠do do manual.</p>
            </div>
        `;

        // --- Atualiza o Painel do Gloss√°rio R√°pido ---
        glossaryDefinition.innerHTML = `
            <div class="space-y-4">
                <h3 class="text-2xl font-extrabold text-gray-900">${term}</h3>
                <p class="text-base text-gray-700 leading-relaxed">${definition}</p>
            </div>
        `;
    }

    // ---------------------------------------------------------------------
    // FUN√á√ÉO PERGUNTE AO GEMINI (APENAS CONTE√öDO DO MANUAL)
    // ---------------------------------------------------------------------

    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    // Consolida todo o conte√∫do detalhado do manual para ser usado como contexto
    const manualContext = mindMapData.flatMap(phase => 
        phase.topics.map(topic => 
            `### ${phase.phase} - ${topic.name}\n${topic.fullContent}\n\n`
        )
    ).join('');


    window.askGemini = async function() {
        const query = document.getElementById('gemini-input').value.trim();
        const resultsDiv = document.getElementById('gemini-results');
        const button = document.getElementById('gemini-button');

        if (!query) {
            resultsDiv.innerHTML = '<p class="text-red-500">Por favor, digite sua pergunta.</p>';
            return;
        }

        // --- CORRE√á√ÉO DE ERRO LOCAL (CORS) ---
        if (!apiKey && window.location.protocol === 'file:') {
            button.disabled = false;
            button.innerHTML = 'Pergunte ao Manual';
            resultsDiv.innerHTML = '<p class="text-red-600 font-semibold">ERRO: Falha na Conex√£o. O acesso √† API √© bloqueado devido √† pol√≠tica CORS quando o arquivo √© executado diretamente do seu computador (protocolo file://).<br><br>Para usar a fun√ß√£o "Pergunte ao Manual", utilize este arquivo dentro do ambiente Canvas ou hospede-o em um servidor web (localhost).</p>';
            return;
        }
        // -------------------------------------


        // Set loading state
        button.disabled = true;
        button.innerHTML = 'Consultando...';
        resultsDiv.innerHTML = '<p class="text-gray-500 italic">Analisando o manual...</p>';

        const systemInstruction = `Voc√™ √© um assistente especializado no manual de "Procedimento de Corte e Poda de √Årvores" fornecido abaixo. Sua √∫nica fonte de informa√ß√£o para responder deve ser o conte√∫do deste manual. Responda √† pergunta do usu√°rio com base EXCLUSIVA e FIDESAMENTE no texto. Se a informa√ß√£o n√£o estiver presente, declare explicitamente que a informa√ß√£o n√£o est√° no manual. Responda em Portugu√™s.\n\n --- Conte√∫do do Manual ---\n ${manualContext}`;

        const payload = {
            contents: [{ parts: [{ text: query }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] },
        };

        let response;
        let attempts = 0;
        const maxAttempts = 3;
        let delay = 1000;

        while (attempts < maxAttempts) {
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "N√£o foi poss√≠vel gerar a resposta.";
                    
                    // Format the output
                    resultsDiv.innerHTML = `<p class="text-gray-800 whitespace-pre-wrap">${text}</p>`;
                    
                    break; // Exit loop on success
                } else {
                    console.error(`Attempt ${attempts + 1} failed with status: ${response.status}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                attempts++;
                console.error(`Fetch error during attempt ${attempts}:`, error);
                if (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                } else {
                    resultsDiv.innerHTML = '<p class="text-red-600">Erro ao consultar o Gemini. Tente novamente.</p>';
                }
            }
        }

        // Reset button state
        button.disabled = false;
        button.innerHTML = 'Pergunte ao Manual';
    };

    // Inicializa a aplica√ß√£o
    window.onload = renderMindMap;

</script>

</body>
</html>
